---
layout: post
title: message durability 消息持久化
tags: rabbitmq 
---

*ACK机制确保即使消费者死了,任务也不会丢失*,但是如果RabbitMQ服务器停止,我们的任务消息仍然会丢失.如果希望即使在RabbitMQ服务重启的情况下,也不会丢失消息,可以将Queue与Message都设置为可持久化(durable),
这样可以保证绝大部分情况下RabbitMQ消息不会丢失.但依然解决不了小概率丢失事件的发生(比如RabbitMQ服务器已经接收到生产者的消息,但还没来得及持久化该消息时RabbitMQ服务器就断电了),
如果需要对这种小概率事件也要管理起来,那么要用到事务.  

**需要两件事来确保消息不丢失:分别将队列和消息标记为持久化**
1. 队列持久化
```
boolean durable = true;
channel.queueDeclare("hello_dirable", durable, false, false, null);
```

2. 消息持久化:设置MessageProperties值为PERSISTENT_TEXT_PLAIN
```
channel.basicPublish("", "hello_dirable", MessageProperties.PERSISTENT_TEXT_PLAIN, message.getBytes());
```

*注意:在RabbitMQ中,已经存在的队列无法修改其属性*

